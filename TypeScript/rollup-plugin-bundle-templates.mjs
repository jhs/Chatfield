/**
 * Rollup plugin to bundle Handlebars templates as TypeScript strings
 *
 * This plugin:
 * 1. Scans the /Prompts directory for .hbs.txt files
 * 2. Generates a loader.browser.ts file with templates as string literals
 * 3. Makes templates available to browser builds without fs/path dependencies
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export default function bundleTemplates() {
  return {
    name: 'bundle-templates',

    buildStart() {
      // Path to Prompts directory (project root)
      const promptsDir = path.join(__dirname, '..', 'Prompts');
      const outputPath = path.join(__dirname, 'chatfield', 'templates', 'loader.browser.ts');

      if (!fs.existsSync(promptsDir)) {
        this.warn(`Prompts directory not found at ${promptsDir}`);
        return;
      }

      // Read all template files
      const templates = {};
      const templateFiles = fs.readdirSync(promptsDir)
        .filter(file => file.endsWith('.hbs.txt'));

      for (const file of templateFiles) {
        const name = file.replace('.hbs.txt', '');
        const content = fs.readFileSync(path.join(promptsDir, file), 'utf-8');
        // Escape backticks and backslashes for template literal
        templates[name] = content
          .replace(/\\/g, '\\\\')
          .replace(/`/g, '\\`')
          .replace(/\$/g, '\\$');
      }

      // Read all partial files
      const partials = {};
      const partialsDir = path.join(promptsDir, 'partials');

      if (fs.existsSync(partialsDir)) {
        const partialFiles = fs.readdirSync(partialsDir)
          .filter(file => file.endsWith('.hbs.txt'));

        for (const file of partialFiles) {
          const name = file.replace('.hbs.txt', '');
          const content = fs.readFileSync(path.join(partialsDir, file), 'utf-8');
          // Escape backticks and backslashes for template literal
          partials[name] = content
            .replace(/\\/g, '\\\\')
            .replace(/`/g, '\\`')
            .replace(/\$/g, '\\$');
        }
      }

      // Generate TypeScript code
      const code = generateLoaderCode(templates, partials);

      // Write the loader.browser.ts file
      fs.writeFileSync(outputPath, code, 'utf-8');

      console.log(`âœ“ Bundled ${Object.keys(templates).length} templates and ${Object.keys(partials).length} partials into loader.browser.ts`);
    }
  };
}

function generateLoaderCode(templates, partials) {
  const templateEntries = Object.entries(templates)
    .map(([name, content]) => `  '${name}': \`${content}\``)
    .join(',\n');

  const partialEntries = Object.entries(partials)
    .map(([name, content]) => `  '${name}': \`${content}\``)
    .join(',\n');

  return `/**
 * Browser template loader - Generated file, do not edit manually!
 *
 * This file is automatically generated by rollup-plugin-bundle-templates.mjs
 * Templates are bundled as string literals for browser use.
 */

const TEMPLATES: Record<string, string> = {
${templateEntries}
};

const PARTIALS: Record<string, string> = {
${partialEntries}
};

/**
 * Get a template by name
 * @param name Template name (without .hbs.txt extension)
 * @returns Template content as string
 */
export function getTemplate(name: string): string {
  const template = TEMPLATES[name];
  if (!template) {
    throw new Error(\`Template not found: \${name}\`);
  }
  return template;
}

/**
 * Get a template partial by name
 * @param name Partial name (without .hbs.txt extension)
 * @returns Partial content as string
 */
export function getTemplatePartial(name: string): string {
  const partial = PARTIALS[name];
  if (!partial) {
    throw new Error(\`Template partial not found: \${name}\`);
  }
  return partial;
}

/**
 * List all available templates
 * @returns Array of template names (without extensions)
 */
export function listTemplates(): string[] {
  return Object.keys(TEMPLATES);
}

/**
 * List all available template partials
 * @returns Array of partial names (without extensions)
 */
export function listTemplatePartials(): string[] {
  return Object.keys(PARTIALS);
}
`;
}

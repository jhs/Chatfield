<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatfield Minimal Example</title>
</head>
<body>
  <h1>Chatfield Browser Example</h1>
  <div id="output"></div>

  <script type="module">
    import { chatfield, Interviewer } from '../../dist/standalone/esm/index.js';

    const output = document.getElementById('output');
    output.innerHTML = '<p>Chatfield OK</p>';

    const form = chatfield()
      .type('Web Test')
      .alice()
        .type('A terse interviewer')
        .trait('Speaks in as few words as possible')
        .trait('Always starts sentences with the preface "No way!"')
      .field('name')
      .field('age')
        .as_int()
      .build();
    
    const interviewer = new Interviewer(form, {
      baseUrl: 'http://127.0.0.1:4000',
      apiKey: 'api-key-TEST',
      llmId: 'jason',
    });

    async function runInterview() {
      let userInput = null;;

      while (true) {
        const msg = await interviewer.go(userInput);

        output.innerHTML += `<p><strong>AI</strong>: ${msg}</p>`;
        output.innerHTML += `<textarea rows="4" cols="50" placeholder="Your response here..."></textarea><br>`;

        if (form._done) {
          output.innerHTML += `<p><strong>Form completed:</strong> ${JSON.stringify(form.values())}</p>`;
          break;
        }

        userInput = await getUserInput();
      }
    }

    async function getUserInput() {
      return new Promise((resolve) => {
        const textarea = output.querySelector('textarea');
        textarea.focus();
        textarea.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            const value = textarea.value.trim();
            if (value) {
              output.innerHTML += `<p><strong>You</strong>: ${value}</p>`;
              textarea.remove();
              resolve(value);
            }
          }
        });
      });
    }

    runInterview();
  </script>
</body>
</html>
